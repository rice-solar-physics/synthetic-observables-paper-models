%% Use AASTeX class, version 6.1
%% Allow for additional class options such as,
%%  twocolumn   : two text columns, 10 point font, single spaced article.
%%                This is the most compact and represent the final published
%%                derived PDF copy of the accepted manuscript from the publisher
%%  manuscript  : one text column, 12 point font, double spaced article.
%%  preprint    : one text column, 12 point font, single spaced article.  
%%  preprint2   : two text columns, 12 point font, single spaced article.
%%  modern      : a stylish, single text column, 12 point font, article with
%% 		            wider left and right margins. This uses the Daniel
%% 		            Foreman-Mackey and David Hogg design.
%%  astrosymb    : Loads Astrosymb font and define \astrocommands. 
%%  tighten      : Makes baselineskip slightly smaller, only works with 
%%                 the twocolumn substyle.
%%  times        : uses times font instead of the default
%%  linenumbers  : turn on lineno package.
%%  trackchanges : required to see the revision mark up and print its output
%%  longauthor   : Do not use the more compressed footnote style (default) for 
%%                 the author/collaboration/affiliations. Instead print all
%%                 affiliation information after each name. Creates a much
%%                 long author list but may be desirable for short author papers

\documentclass[preprint,linenumbers]{aastex62}
%% Include packages
\usepackage{amsmath}
%% Custom commands
\DeclareMathOperator*{\argmax}{arg\,max} % in your preamble
\newcommand{\AR}{active region }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   Body                                      %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   Title and Authors                         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{Timelag Analysis of Simulated Active Region Cores Heated by Nanoflares}
\author[0000-0001-9642-6089]{W. T. Barnes}
\author{S. J. Bradshaw}
\affiliation{Department of Physics \& Astronomy, Rice University, Houston, TX 77005-1827}
\author{N. M. Viall}
\affiliation{NASA Goddard Space Flight Center, Greenbelt, MD 20771}
\correspondingauthor{W. T. Barnes}
\email{will.t.barnes@rice.edu}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   Abstract                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract}
The abstract will go here.
\end{abstract}
%% Keywords
\keywords{Sun,corona,nanoflares,active regions}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   Introduction                              %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}\label{introduction}

This is my whole paper. There is not much here. Here's how to cite a
paper \citet{viall_evidence_2012}. Here's another example of how to cite
a paper \citep{warren_constraints_2011}.

\authorcomment1{What is(are) the overall point(s) of this paper?}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   Methods                                   %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Modeling}
\label{modeling}
In this section, we describe our pipeline for building a model active region and discuss each of the pieces in detail.

Somewhere, discuss 

\subsection{Magnetic Field Extrapolation}
\label{field}
\authorcomment1{Give details about method used to perform field extrapolation, how the fieldlines are traced. Show fieldlines overlaid on magnetogram.}

We choose active region (AR) NOAA 1158, as observed by the HMI instrument \citet{hoeksema_helioseismic_2014} on 12 February 2011, from the list of active regions studied by \citet{warren_systematic_2012}. We model the geometry of AR NOAA 1158 by computing the three-dimensional magnetic field using the potential field extrapolation method of \citet{schmidt_observable_1964} as outlined in section 3 of \citet{sakurai_greens_1982}. 

\begin{figure}
    %\plotone{dummy}
    \caption{AR NOAA 1158 with extrapolated fieldlines overlaid}
    \label{fig:magnetogram}
\end{figure}

\subsection{Loop Hydrodynamics}
\label{loops}
The low plasma-$\beta$ in the corona allows us to model the solar atmosphere as an ensemble of independently-heating loops using a field-aligned hydrodynamic model. To model the dynamics of each individual loop, we use the enthalpy-based thermal evolution of loops (EBTEL) model \citep{klimchuk_highly_2008,cargill_enthalpy-based_2012}. Specifically, we use the version of two-fluid version of the EBTEL model as described in \citep{barnes_inference_2016}. EBTEL solves the time-dependent, spatially-integrated hydrodynamic equations and has been successfully benchmarked against field-aligned hydrodynamic codes. Though EBTEL only computes spatially-averaged quantities in the coronal portion of the loop, its efficiency allows us to calculate time-dependent solutions for many thousands of loops in a few minutes.


\subsection{Heating Model}
\label{heating}
Explain the impulsive heating model, the different frequencies that will be used, the method for constraining the model. Also discuss how the underlying structure and strength of the field may influence the heating and thus the synthesized emission.

Show sample plot with three panels: 1) heating, 2) temperature, and 3) density as a function of time for high, intermediate, and low frequency heating for a single loop.

\subsection{Forward Modeling}
\label{forward}
This section will summarize our pipeline for building our forward model (by example). Explain here what AR we have chosen and brief outline of the section.

\subsubsection{Atomic Physics}
\label{atomic}
To calculate the forward modeled intensities, we account for the contributions of all transitions of all ions for a selected number of elements (see \autoref{tab:element_table}). For an optically thin, high-temperature ($\sim10^6$ K), low-density ($\sim10^9$ cm$^{-3}$) plasma, the radiated power per unit volume for a transition $\lambda_{ij}$ of an electron in ion $k$ of element $X$ is given by,

\begin{equation}
    \label{eq:ppuv}
    P(\lambda_{ij}) = n_j(X_k)A_{ji}\Delta E_{ji},\quad[\text{erg cm}^{-3}\text{ s}^{-1}]
\end{equation}
where $n_j$ is the number density of ions $X_k$ in excited state $j$, $A_{ji}$ is the Einstein coefficient, and $\Delta E_{ji}=hc/\lambda_{ij}$ is the energy of the emitted photon  \citep[see][]{mason_spectroscopic_1994,bradshaw_collisional_2013}. \autoref{eq:ppuv} can be rewritten in the more useful form,

\begin{eqnarray*}
    P(\lambda_{ij}) &=& \frac{n_j(X_k)}{n(X_k)}\frac{n(X_k)}{n(X)}\frac{n(X)}{n(H)}\frac{n(H)}{n_e}n_eA_{ji}\Delta E_{ji}, \\
    &=& N_j(X,k) f_{X,k} \mathrm{Ab}(X) 0.83 n_e A_{ji} \Delta E_{ji}, \\
    &=& 0.83 \mathrm{Ab}(X) f_{X,k} N_j(X,k) A_{ji} \Delta E_{ji} n_e,
\end{eqnarray*}
where, $N_j$ is the fractional energy level population of level $j$, $f_{X,k}$ is the fractional population of ion $k$, $\mathrm{Ab}(X)$ is the abundance of element $X$ relative to hydrogen, and the ratio of hydrogen and electron number densities is $\approx0.83$. 

Noting that the \textit{emissivity} of the spectral line can be written as $\epsilon_{ij}=N_j A_{ji} \Delta E_{ji}$
\begin{deluxetable}{ccc}
    \caption{Elements including in forward-modeled intensity calculation\label{tab:element_table}}
    \tablehead{
        \colhead{Element} & \colhead{Number of Ions} & \colhead{Number of Transitions}
    }
    \startdata
    \enddata
\end{deluxetable}

Show expression for the intensity and discuss components and how they are calculated, i.e. with CHIANTI. Give details about non-equilibrium ionization calculation as well.

Include table with all elements, including number of ions and number of transitions

\subsubsection{Instrument Effects}
\label{instrument}

Make point about using instrument response functions versus including a full nonequilibrium treatment. This will be discussed more in depth in the results section as well. Show a $n-T$ phase space for typical loop evolution and then for constant pressure.

Show plot of temperature response functions with contributions from each element overlaid

How the emission is binned, point-spread function applied, correct resolution. Some details about how results can be analyzed in same manner as real observations. This can be relatively brief.

Also show that our chosen elements fill in the temperature response function appropriately.

\section{Analysis}
\label{analysis}

\authorcomment2{Should this whole section just go in the results section?}

\subsection{Timelag Analysis}
\label{timelag_analysis}

We apply the timelag method of \citet{viall_evidence_2012} to both our simulated and observed intensities. To find the associated timelag for a channel pair in a given pixel, we compute the cross-correlation between the timeseries associated with each channel and find the lag which maximizes this cross-correlation. We can express the cross-correlation $\mathcal{C}$ between two channels $A$ and $B$ as,

\begin{equation}\label{eq:cc_pre}
    \mathcal{C}_{AB}(\tau) = \mathcal{I}_A(t)\star\mathcal{I}_B(t) = \mathcal{I}_A(-t)\ast\mathcal{I}_B(t)
\end{equation}

where $\star$ and $\ast$ represent the correlation and convolution operators, respectively, $\mathcal{I}_c(t)=(I_c(t)-\bar{I}_c)/\sigma_{I_c}$ is the mean-subtracted and scaled intensity of channel $c$ as a function of time, and $\tau$ is the lag. Taking the fourier transform of both sides of \autoref{eq:cc_pre} and using the convolution theorem,

\begin{align}\label{eq:cc}
    \mathcal{F}(\mathcal{C}_{AB}) &= \mathcal{F}(\mathcal{I}_A(-t)\ast\mathcal{I}_B(t)), \nonumber\\
    &= \mathcal{F}(\mathcal{I}_A(-t))\mathcal{F}(\mathcal{I}_B(t)), \nonumber\\
    \mathcal{C}_{AB}(\tau) &= \mathcal{F}^{-1}(\mathcal{F}(\mathcal{I}_A(-t))\mathcal{F}(\mathcal{I}_B(t))).
\end{align}

Furthermore, the \textit{timelag} between channels $A$ and $B$ is defined as,

\begin{equation}
    \tau_{AB} = \argmax_{\tau}\,\mathcal{C}_{AB}(\tau).
\end{equation}

\authorcomment2{Show example timelag here for a cooling case}

By exploiting the definition of the cross-correlation as given in \autoref{eq:cc}, we can leverage existing Fourier transform algorithms in order to compute the $\mathcal{C}_{AB}$ in a scalable and efficient manner. For a 500 pixel by 500 pixel active region observation and 15 possible channel pairs, we need to compute $\tau_{AB}$ nearly $4\times10^6$ times. We use the highly-optimized and thoroughly tested Fourier transform algorithms in the NumPy python package for array computations \citep{oliphant_guide_2006} combined with the Dask library for parallel and distributed computing \citep{dask_development_team_dask_2016}. Using Dask, we are able to parallelize this operation over many cores such that, on a 64-core machine, we are able to compute timelags for all 15 channel pairs in every pixel of the \AR in approximately twenty minutes. 

\authorcomment2{Show an example dask DAG here?}

\subsection{Emission Measure Distributions}
\label{em_dist}

\authorcomment1{Describe method for computing EM distributions and slopes}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   Results                                   %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}
\label{results}
\authorcomment1{High, intermediate, and low frequency cases plus control models. How should these be divided up?}

Two questions we want to try to answer:
\begin{enumerate}
    \item How is the timelag related to the heating frequency?
    \item What heating model is most consistent with observed timelags?
\end{enumerate}

\subsection{Intensities}
Compare different heating frequencies for different channel pairs using maps and histograms

Compare with observations shown in \citet{viall_survey_2017}.

\subsection{Timelags}

\subsection{Emission Measure Slopes}

\subsection{Comparison with Observations}
\label{compare_obs}

\authorcomment1{Here, show observed timelags (do not really need to show intensities I don't think...) and observed EM slopes}
\authorcomment1{Describe random forest technique, results of the classification}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   Summary                                   %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Summary and Conclusion}
\label{conclusions}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   Acknowledgment                            %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\acknowledgments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   Software                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\software{Astropy\citep{astropy_collaboration_astropy_2013}, Dask\citep{dask_development_team_dask_2016}, Matplotlib\citep{hunter_matplotlib_2007}, NumPy\citep{oliphant_guide_2006}, SunPy\citep{sunpy_community_sunpypython_2015}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                   References                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliographystyle{aasjournal.bst}
\bibliography{references.bib}
\end{document}
